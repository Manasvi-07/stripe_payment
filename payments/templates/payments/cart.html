<!DOCTYPE html>
<html>
  <head>
    <title>Your Cart</title>
    <script src="https://js.stripe.com/v3/"></script>
  </head>
  <body>
    <h2>Shopping Cart</h2>

    <h2>Your Cart</h2>

    {% if products %}
      <ul>
        {% for item in products %}
          <li>{{ item.product.name }} - ₹{{ item.unit_amount|floatformat:2 }}</li>
        {% endfor %}
      </ul>

      <h3>Total: ₹{{ total|floatformat:2 }}</h3>

      <form method="post" action="{% url 'checkout_cart' %}">
        {% csrf_token %}
        <button type="submit">Checkout</button>
      </form>
    {% else %}
      <p>Your cart is empty.</p>
    {% endif %}

    <script>
    
      async function checkout() {
        const email = document.getElementById("email").value;
        if (!email) {
          alert('Please enter your email.')
          return
        }
      
        try {
          const response = await fetch('/checkout-cart/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ email: email })
          })
      
          const data = await response.json()
          if (data.id) {
            const stripe = Stripe('{{ stripe_publishable_key }}')
            stripe.redirectToCheckout({ sessionId: data.id })
          } else {
            alert('Checkout failed: ' + (data.error || 'Unknown error'))
          }
        } catch (error) {
          console.error('Checkout error:', error)
          alert('An error occurred during checkout.')
        }
      }
    </script>
  </body>
</html>
